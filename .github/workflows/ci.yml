name: "CI"

on: pull_request

concurrency:
  group: ci-${{ github.head_ref }}
  cancel-in-progress: true

jobs:
  build:
    name: "Build"
    runs-on: ubuntu-latest
    steps:
    - name: "Checkout code (pre merge)"
      uses: actions/checkout@v2
      with:
        # Checkout the current commit instead of the commit that would get
        # made when the PR would be merged, since we want to validate that
        # the branch doesn't contain any merge commits and is rebased correctly.
        # We also fetch all the objects here so that we can do the comparisons.
        ref: ${{ github.event.pull_request.head.sha }}
        fetch-depth: 0

    - name: "Check commits of the PR branch"
      run: ./.github/check_commits.sh

    - name: "Checkout code (post merge)"
      uses: actions/checkout@v2

    - name: "Set up Docker Buildx"
      uses: docker/setup-buildx-action@94ab11c41e45d028884a99163086648e898eed25  # v1.6.0

    - name: "Set up Docker layer caching"
      uses: ruohola/cache@main
      with:
        path: /tmp/.buildx-cache
        key: ${{ runner.os }}-buildx-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-buildx-

    - name: "Build and cache the image"
      uses: docker/build-push-action@a66e35b9cbcf4ad0ea91ffcaf7bbad63ad9e0229  # v2.7.0
      with:
        context: .
        target: ci
        tags: frontend-ci
        load: true
        cache-from: type=local,src=/tmp/.buildx-cache
        cache-to: type=local,dest=/tmp/.buildx-cache-new

    - name: "Move cache"
      # https://github.com/docker/build-push-action/issues/252
      # https://github.com/moby/buildkit/issues/1896
      run: |
        rm -rf /tmp/.buildx-cache
        mv /tmp/.buildx-cache-new /tmp/.buildx-cache

    - name: "Run linters, type-check, and tests"
      run: docker run --name frontend-ci frontend-ci
